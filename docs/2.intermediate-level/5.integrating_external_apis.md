# ğŸ”Œ `integrating_external_apis.md`

> Learn how to call and display **external REST APIs** inside Umbraco Razor views or controllers â€” with best practices for caching, services, and error handling ğŸ§ ğŸŒ

---

## ğŸ’¡ Why Integrate APIs?

External APIs let you pull in live data like:

| Use Case             | API Example              |
| -------------------- | ------------------------ |
| ğŸŒ¦ï¸ Weather Widget    | OpenWeather API          |
| ğŸ“° Blog Feed         | Medium, Dev.to API       |
| ğŸ›’ Product Inventory | Shopify or Stripe        |
| ğŸ’¸ Exchange Rates    | Currency conversion APIs |
| ğŸ” Search Services   | Algolia, Meilisearch     |

---

## ğŸ§  Integration Strategy

| Method        | Use When...                           |
| ------------- | ------------------------------------- |
| Razor Fetch   | Simple GET request to render on page  |
| Service Layer | Multiple API calls, reuse, or testing |
| JS Fetch      | API called client-side via JS/AJAX    |
| API Proxy     | Build your own API wrapper in Umbraco |

Weâ€™ll use **Razor + HttpClient + Service** for full control ğŸ’ª

---

## ğŸ§± Step-by-Step: Display Weather from OpenWeather API

---

### ğŸ“¦ Step 1: Create API Service

ğŸ“ File: `Services/WeatherService.cs`

```csharp
using System.Net.Http;
using System.Text.Json;
using System.Threading.Tasks;

public class WeatherService
{
    private readonly HttpClient _http;
    private readonly string _apiKey = "YOUR_API_KEY";

    public WeatherService(HttpClient http)
    {
        _http = http;
    }

    public async Task<string> GetWeatherAsync(string city)
    {
        var response = await _http.GetAsync($"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={_apiKey}&units=metric");
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadAsStringAsync();
        using var doc = JsonDocument.Parse(json);
        var temp = doc.RootElement.GetProperty("main").GetProperty("temp").GetDecimal();

        return $"{city}: {temp}Â°C";
    }
}
```

---

### ğŸ›  Step 2: Register the Service in `Program.cs`

```csharp
builder.Services.AddHttpClient<WeatherService>();
```

Now your service is injectable! ğŸ§ 

---

### ğŸ§¾ Step 3: Call It in a ViewComponent or Controller

ğŸ“ File: `ViewComponents/WeatherViewComponent.cs`

```csharp
public class WeatherViewComponent : ViewComponent
{
    private readonly WeatherService _weather;

    public WeatherViewComponent(WeatherService weather)
    {
        _weather = weather;
    }

    public async Task<IViewComponentResult> InvokeAsync(string city)
    {
        var result = await _weather.GetWeatherAsync(city);
        return View("Weather", result);
    }
}
```

ğŸ“ File: `Views/Shared/Components/Weather/Weather.cshtml`

```cshtml
@model string
<div class="weather-box">
    <p>â˜ï¸ Weather: @Model</p>
</div>
```

---

### ğŸ§© Step 4: Render in Razor View

Anywhere in your page (`Home.cshtml`, etc):

```cshtml
@await Component.InvokeAsync("Weather", new { city = "Cairo" })
```

---

## âš™ï¸ Option: Just Call API Inside Razor (Quick & Dirty)

```cshtml
@inject WeatherService Weather

@{
    var data = await Weather.GetWeatherAsync("Dubai");
}
<p>@data</p>
```

---

## ğŸ§  Best Practices

| Practice                                    | Why It Matters                    |
| ------------------------------------------- | --------------------------------- |
| âœ… Use `HttpClientFactory`                  | Avoid socket exhaustion           |
| âœ… Use async/await                          | Prevent blocking threads          |
| âœ… Add error handling                       | Donâ€™t crash your site on 500s     |
| âœ… Use `JsonDocument` or `System.Text.Json` | Avoid `dynamic` mess              |
| ğŸ§  Cache API responses                      | Save on API calls & improve speed |

---

### ğŸ§° Add Basic Caching Example

ğŸ“ File: `WeatherService.cs` (enhanced)

```csharp
private static Dictionary<string, (DateTime timestamp, string value)> _cache = new();

public async Task<string> GetWeatherAsync(string city)
{
    if (_cache.TryGetValue(city, out var cached) && DateTime.Now - cached.timestamp < TimeSpan.FromMinutes(10))
        return cached.value;

    // Fetch and cache
    ...
    _cache[city] = (DateTime.Now, result);
    return result;
}
```

ğŸ§  Use IMemoryCache for advanced control.

---

## ğŸ‘€ JSON Viewer Tip

When working with APIs, use:

- [https://jsonformatter.org/json-viewer](https://jsonformatter.org/json-viewer)
- Chrome/VSCode JSON viewer extensions

To explore the structure and find the exact path to access fields.

---

## âœ… Summary

| Step           | Task                                  |
| -------------- | ------------------------------------- |
| Create Service | Class with HttpClient                 |
| Register       | `builder.Services.AddHttpClient<T>()` |
| Use in Razor   | ViewComponent / Injected View         |
| Bonus          | Add caching & error handling          |

---

## ğŸš€ Practice Challenge

- Use [https://api.coindesk.com/v1/bpi/currentprice.json](https://api.coindesk.com/v1/bpi/currentprice.json)
- Build a `BitcoinService` that displays live BTC price
- Show it on homepage via ViewComponent
